@using MediaPortal.Models
@model UserFilesViewModels
@{
    ViewBag.Title = "UserFilesTitle";
    Layout = "~/Views/Shared/LogoLayout.cshtml";
}

@section userRoutes{
    @for (var i = 0; i < Model.FolderIDs.Count; i++)
    {
        <span id="icon-href-delimiter"></span>
        @Html.ActionLink(Model.FolderNames.ElementAt(i), "UserFiles", "Home", new { folderID = Model.FolderIDs.ElementAt(i) }, htmlAttributes: null)
        
    }
}

@if (Model.Files.ToList().Count == 0)
{
    if (Request.Cookies["registered"] == null)
    {
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <div class="col-md-12 registerText">Эта папка пустая.
                    <br />
                    Пожалуйста загрузите ваши файлы.</div>
                    <div class="col-md-4 col-md-offset-4">
                        @Html.Partial("_UploadCreatePartial", new FileSystemModels() { ParentId = Model.FolderIDs.Count != 0 ? Model.FolderIDs.Last() : null })
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-md-offset-3">
                <div class="col-md-12 registerText">Вы успешно зарегистрированы</div>
                <div class="col-md-8 col-md-offset-2 text-center">
                    Теперь вы можете начать использование LOGO!
                    Загружайте свои файлы и делитесь ими
                    с остальными пользователями!
                </div>
                <div class="col-md-4 col-md-offset-4">
                    @Html.Partial("_UploadCreatePartial", new FileSystemModels() { ParentId = Model.FolderIDs.Count != 0 ? Model.FolderIDs.Last() : null })
                </div>
            </div>
        </div>
    </div>
    }
}
else
{
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="col-md-12">
                    <div class="col-md-3">Название</div>
                </div>
                <div class="col-md-9">
                    <div class="row">
                        <div class="col-md-12">

                            @foreach (var item in Model.Files)
                            {
                                if (item.Type.Equals("Folder"))
                                {
                                    @Html.Partial("FileSystemFolderBlockView", item)
                                }
                            }
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            @foreach (var item in Model.Files)
                            {
                                if (!item.Type.Equals("Folder"))
                                {
                                    @Html.Partial("FileSystemBlockView", item)
                                }
                            }
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-md-offset-1 ">
                    @Html.Partial("_UploadCreatePartial", new FileSystemModels() { ParentId = Model.FolderIDs.Count != 0 ? Model.FolderIDs.Last() : null })
                </div>
            </div>
        </div>
    </div>
   
}

<div class="col-md-1 hide rmenu" id="rmenu-folder">
    <ul class="rmenu-ul">
        <li class="rmenu-li" id="rename">Переименовать</li>
        <li class="rmenu-li" id="add-tag" data-toggle="modal" data-target="#ModalTag">Добавить тег</li>
        <li class="rmenu-li" id="zip-download">Скачать ZIP-архив</li>
        <li class="rmenu-li" id="folder-delete" data-toggle="modal" data-target="#ModalDelete">Удалить папку</li>
    </ul>
</div>

<div class="col-md-1 hide rmenu" id="rmenu-file">
    <ul class="rmenu-ul">
        <li class="rmenu-li" id="rename">Переименовать</li>
        <li class="rmenu-li" id="add-tag" data-toggle="modal" data-target="#ModalTag">Добавить тег</li>
        <li class="rmenu-li" id="file-download">Скачать файл</li>
        <li class="rmenu-li" id="file-delete" data-toggle="modal" data-target="#ModalDelete">Удалить файл</li>
    </ul>
</div>

<!-- Modal -->
<div class="modal fade " id="ModalDelete" role="dialog">
    <div class="modal-dialog ">
        <!-- Modal content-->
        <div class="modal-content col-md-6 col-md-offset-4  ModalDeleteww">
            <div class="modal-body col-md-12 col-md-offset-1  ModalDeleterr">

                <div class="col-md-12 ModalDeleterr1">
                    Вы уверенны, что хотите удалить этот файл
                </div>
                <div class="col-md-12 ModalDeleterr ModalDeleterr1">
                    <div class="btn btn-primary col-md-5 ModalDeletecastomPadBot" data-dismiss="modal">Ой нет!</div>
                    <div class="btn btn-primary col-md-5 col-md-offset-1  ModalDeletebtn-primary2 ModalDeletecastomPadBot" data-dismiss="modal" onclick="DeleteFileSystem();">Да, удалить!</div>
                </div>

            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="ModalTag" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content col-md-offset-2 col-md-10 modal-content-tag">
            <div class="row">
                <div class="col-md-12 row-tag">
                    <div class="modal-header modal-header-tag">
                        <h3 class="modal-title modal-title-tag"><strong>Добавить тег</strong></h3>
                    </div>
                    <div class="modal-body modal-body-tag">
                        <textarea class="form-control form-control-tag" id="text-tag" maxlength="200"></textarea>
                    </div>
                    <div class="modal-footer modal-footer-tag">
                        <div class="row">
                            <div class="col-md-6 row-tag2">
                                <div>Максимальное</div><div class="tag-count">количество тегов - 200</div>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-primary btn-tag" data-dismiss="modal" onclick="AddTag()">Добавить</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(".fileSystem-list-item").dblclick(function () {

            var folderId = $(this).data("name");
            var folderName = $(this).data("folder-name");
            var link = "/Home/UserFiles/" + folderId + "/" + folderName;

            window.location.href = link;

        });

        $(".fileSystem-list-item").click(function () {
            $(this).toggleClass("fileSystem-list-item-active");
        });      

        $(".fileSystem-list-item-file").click(function () {
            $(this).toggleClass("fileSystem-list-item-file-active");
        });

    </script>
    
<script>
        var els = $('.context-menu-folder');
        for (var i = 0; i < els.length; i++) {
            if (els[i].addEventListener) {
                els[i].addEventListener('contextmenu', function (e) {

                    if (!$(this).is(".fileSystem-list-item-active")) {
                        $(this).toggleClass("fileSystem-list-item-active");
                    }


                    var file = 0;
                    var folder = 0;

                    $(".context-menu-folder").each(function (index, element) {
                        if ($(this).is(".fileSystem-list-item-active")) {
                            folder += 1;
                        };
                    });

                    $(".context-menu-file").each(function (index, element) {
                        if ($(this).is(".fileSystem-list-item-file-active")) {
                            file += 1;
                        };
                    });

                    if (folder == 1 && file < 1) {
                        document.getElementById("zip-download").innerHTML = "Скачать ZIP-архив";
                        document.getElementById("folder-delete").innerHTML = "Удалить папку";

                    }
                    else if (folder > 1 && file < 1) {
                        document.getElementById("zip-download").innerHTML = "Скачать ZIP-архив";
                        document.getElementById("folder-delete").innerHTML = "Удалить папки";
                    }
                    else {
                        document.getElementById("zip-download").innerHTML = "Скачать ZIP-архив";
                        document.getElementById("folder-delete").innerHTML = "Удалить обьекты";
                    }


                    $("#rmenu-folder").toggleClass("hide");
                    $("#rmenu-folder").css({
                        position: "absolute",
                        top: e.pageY,
                        left: e.pageX
                    }
                    );
                    e.preventDefault();
                }, false);
            }
        }
</script>

<script>

        var els = $('.context-menu-file');
        for (var i = 0; i < els.length; i++) {
            if (els[i].addEventListener) {
                els[i].addEventListener('contextmenu', function (e) {

                    if (!$(this).is(".fileSystem-list-item-file-active")) {
                        $(this).toggleClass("fileSystem-list-item-file-active");
                    }


                    var file = 0;
                    var folder = 0;

                    $(".context-menu-folder").each(function (index, element) {
                        if ($(this).is(".fileSystem-list-item-active")) {
                            folder += 1;
                        };
                    });

                    $(".context-menu-file").each(function (index, element) {
                        if ($(this).is(".fileSystem-list-item-file-active")) {
                            file += 1;
                        };
                    });

                    if (folder < 1 && file == 1) {
                        document.getElementById("file-download").innerHTML = "Скачать файл";
                        document.getElementById("file-delete").innerHTML = "Удалить файл";

                    }
                    else if (folder < 1 && file > 1) {
                        document.getElementById("file-download").innerHTML = "Скачать ZIP-архив";
                        document.getElementById("file-delete").innerHTML = "Удалить файлы";
                    }
                    else {
                        document.getElementById("file-download").innerHTML = "Скачать ZIP-архив";
                        document.getElementById("file-delete").innerHTML = "Удалить обьекты";
                    }

                    $("#rmenu-file").toggleClass("hide");
                    $("#rmenu-file").css({
                        position: "absolute",
                        top: e.pageY,
                        left: e.pageX
                    }
                    );
                    e.preventDefault();
                }, false);
            }
        }
</script>

<script>
        $(document).bind("click", function (event) {
            document.getElementById("rmenu-folder").className = "col-md-1 hide rmenu";
            $(this).toggleClass("fileSystem-list-item-active");
        });
</script>

<script>
        $(document).bind("click", function (event) {
            document.getElementById("rmenu-file").className = "col-md-1 hide rmenu";
        });
</script>

<script>

    function DeleteFileSystem() {

            var fileSystemIdList = [];

            $(".context-menu-folder").each(function (index, element) {
                if ($(this).is(".fileSystem-list-item-active")) {
                    fileSystemIdList.push($(this).data("name"));
                };
            });

            $(".context-menu-file").each(function (index, element) {
                if ($(this).is(".fileSystem-list-item-file-active")) {
                    fileSystemIdList.push($(this).data("name"));
                };
            });

            $.ajax({
            url: '@Url.Action("DeleteFileSystem", "Home")',
            type: 'POST',
            dataType: 'json',
            traditional: true,

            data: {
                fileSystemsId: fileSystemIdList
            }
            });

        }

</script>
}